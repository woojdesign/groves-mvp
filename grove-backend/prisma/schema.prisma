// Grove MVP - Prisma Schema
// Defines all 10 database tables for the Grove MVP backend

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 1. ORGANIZATIONS
// ============================================
model Org {
  id        String   @id @default(uuid())
  name      String
  domain    String   @unique
  status    String   @default("active") // active, inactive

  // SSO configuration (Phase 1: Enterprise SSO)
  ssoEnabled       Boolean  @default(false) @map("sso_enabled")
  ssoProvider      String?  @map("sso_provider")      // saml | oidc
  samlMetadataUrl  String?  @map("saml_metadata_url")
  samlEntityId     String?  @map("saml_entity_id")
  oidcIssuer       String?  @map("oidc_issuer")
  oidcClientId     String?  @map("oidc_client_id")
  oidcClientSecret String?  @map("oidc_client_secret") // Encrypted
  ssoMetadata      Json?    @map("sso_metadata")       // Additional config

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users User[]

  @@map("orgs")
}

// ============================================
// 2. USERS
// ============================================
model User {
  id         String    @id @default(uuid())
  email      String    @unique
  name       String
  orgId      String    @map("org_id")
  status     String    @default("active") // active, paused, deleted
  role       String    @default("user")   // user, org_admin, super_admin (Phase 1: RBAC)
  lastActive DateTime? @map("last_active")

  // SSO fields (Phase 1: Enterprise SSO)
  ssoProvider  String?  @map("sso_provider")   // saml | oidc | magic_link
  ssoSubject   String?  @map("sso_subject")    // IdP user ID
  ssoMetadata  Json?    @map("sso_metadata")   // IdP-specific claims

  // Dev Dashboard: Test data flag (Phase 1: Data Isolation)
  isTestData   Boolean  @default(false) @map("is_test_data")

  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  org         Org           @relation(fields: [orgId], references: [id], onDelete: Cascade)
  profile     Profile?
  embedding   Embedding?
  matchesAsA  Match[]       @relation("MatchUserA")
  matchesAsB  Match[]       @relation("MatchUserB")
  feedback    Feedback[]
  reportsMade SafetyFlag[]  @relation("Reporter")
  reportsReceived SafetyFlag[] @relation("Reported")
  events      Event[]

  @@index([orgId])
  @@index([email])
  @@index([status])
  @@index([ssoProvider, ssoSubject])
  @@index([isTestData])
  @@map("users")
}

// ============================================
// 3. PROFILES
// ============================================
model Profile {
  id             String   @id @default(uuid())
  userId         String   @unique @map("user_id")
  interests      String   @map("interests") @db.Text
  project        String   @db.Text
  connectionType String   @map("connection_type")
  deepDive       String?  @map("deep_dive") @db.Text
  preferences    String?  @db.Text

  // Dev Dashboard: Test data flag (Phase 1: Data Isolation)
  isTestData     Boolean  @default(false) @map("is_test_data")

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isTestData])
  @@map("profiles")
}

// ============================================
// 4. EMBEDDINGS
// ============================================
model Embedding {
  id            String   @id @default(uuid())
  userId        String   @unique @map("user_id")
  interestsText String   @map("interests_text") @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Vector column will be added via raw SQL migration
  // embedding vector(1536)

  @@map("embeddings")
}

// ============================================
// 5. MATCHES
// ============================================
model Match {
  id              String    @id @default(uuid())
  userAId         String    @map("user_a_id")
  userBId         String    @map("user_b_id")
  similarityScore Float     @map("similarity_score")
  sharedInterest  String?   @map("shared_interest")
  context         String?   @db.Text
  status          String    @default("pending") // pending, accepted, rejected, expired
  expiresAt       DateTime? @map("expires_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  userA User   @relation("MatchUserA", fields: [userAId], references: [id], onDelete: Cascade)
  userB User   @relation("MatchUserB", fields: [userBId], references: [id], onDelete: Cascade)
  intro Intro?

  @@unique([userAId, userBId])
  @@index([userAId])
  @@index([userBId])
  @@index([status])
  @@map("matches")
}

// ============================================
// 6. INTROS (Double Opt-In State Machine)
// ============================================
model Intro {
  id           String    @id @default(uuid())
  matchId      String    @unique @map("match_id")
  userAStatus  String    @default("pending") @map("user_a_status") // pending, accepted, passed
  userBStatus  String    @default("pending") @map("user_b_status") // pending, accepted, passed
  status       String    @default("pending") // pending, accepted_by_a, accepted_by_b, mutual, rejected, expired
  introSentAt  DateTime? @map("intro_sent_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  match    Match      @relation(fields: [matchId], references: [id], onDelete: Cascade)
  feedback Feedback[]

  @@index([status])
  @@map("intros")
}

// ============================================
// 7. FEEDBACK
// ============================================
model Feedback {
  id        String   @id @default(uuid())
  introId   String   @map("intro_id")
  userId    String   @map("user_id")
  didMeet   String?  @map("did_meet") // yes, scheduled, no
  helpful   Boolean?
  note      String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  intro Intro @relation(fields: [introId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([introId])
  @@index([userId])
  @@map("feedback")
}

// ============================================
// 8. SAFETY FLAGS (Reports & Moderation)
// ============================================
model SafetyFlag {
  id             String    @id @default(uuid())
  reporterId     String    @map("reporter_id")
  reportedId     String    @map("reported_id")
  matchId        String?   @map("match_id")
  reason         String
  comment        String?   @db.Text
  status         String    @default("pending") // pending, reviewed, actioned, dismissed
  actionTaken    String?   @map("action_taken") // warning, strike, ban, none
  reviewedAt     DateTime? @map("reviewed_at")
  reviewedBy     String?   @map("reviewed_by")
  createdAt      DateTime  @default(now()) @map("created_at")

  reporter User @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reported User @relation("Reported", fields: [reportedId], references: [id], onDelete: Cascade)

  @@index([reportedId])
  @@index([status])
  @@map("safety_flags")
}

// ============================================
// 9. EVENTS (Audit Log)
// ============================================
model Event {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  eventType String   @map("event_type")
  metadata  Json?
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent") @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("events")
}

// ============================================
// 10. AUTH TOKENS (Magic Links)
// ============================================
model AuthToken {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([token])
  @@index([email])
  @@index([expiresAt])
  @@map("auth_tokens")
}

// ============================================
// 11. ADMIN ACTIONS (Phase 1: RBAC & Audit)
// ============================================
model AdminAction {
  id         String   @id @default(uuid())
  adminId    String   @map("admin_id")
  action     String                   // create_user, delete_user, update_org, etc.
  targetType String   @map("target_type")  // user, org, match, etc.
  targetId   String?  @map("target_id")
  orgId      String?  @map("org_id")   // Org context for multi-tenancy
  metadata   Json?
  ipAddress  String   @map("ip_address")
  userAgent  String   @map("user_agent") @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([adminId])
  @@index([orgId])
  @@index([action])
  @@index([createdAt])
  @@map("admin_actions")
}
